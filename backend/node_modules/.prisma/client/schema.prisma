generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  STUDENT
  INSTRUCTOR
  ADMIN
}

enum TicketStatus {
  OPEN
  CLOSED
}

model User {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  password  String
  role      Role
  levelId   String?
  createdAt DateTime @default(now())

  level         Level?          @relation(fields: [levelId], references: [id])
  courses       Course[]        @relation("InstructorCourses")
  enrollments   Enrollment[]
  quizAttempts  QuizAttempt[]
  progress      Progress[]
  subscriptions Subscription[]
  certificates  Certificate[]
  forumPosts    ForumPost[]
  forumComments ForumComment[]
  tickets       SupportTicket[]
}

model Level {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  users       User[]
  subjects    Subject[]
}

model Subject {
  id      String   @id @default(uuid())
  code    String   @unique
  name    String
  levelId String
  level   Level    @relation(fields: [levelId], references: [id], onDelete: Cascade)
  courses Course[]
}

model Course {
  id           String   @id @default(uuid())
  title        String
  description  String?
  subjectId    String
  instructorId String
  isPublished  Boolean  @default(false)
  createdAt    DateTime @default(now())

  subject      Subject       @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  instructor   User          @relation("InstructorCourses", fields: [instructorId], references: [id])
  lessons      Lesson[]
  enrollments  Enrollment[]
  progress     Progress[]
  certificates Certificate[]
  forumPosts   ForumPost[]
}

model Lesson {
  id            String   @id @default(uuid())
  courseId      String
  title         String
  content       String?
  videoUrl      String?
  attachmentUrl String?
  orderNumber   Int
  isFree        Boolean  @default(false)
  createdAt     DateTime @default(now())

  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  quiz   Quiz?
}

model Quiz {
  id       String @id @default(uuid())
  lessonId String @unique
  passMark Int

  lesson    Lesson        @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  questions Question[]
  attempts  QuizAttempt[]
}

model Question {
  id     String @id @default(uuid())
  quizId String
  text   String

  quiz    Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  options Option[]
}

model Option {
  id         String  @id @default(uuid())
  questionId String
  text       String
  isCorrect  Boolean @default(false)

  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model Enrollment {
  id         String   @id @default(uuid())
  studentId  String
  courseId   String
  enrolledAt DateTime @default(now())

  student User   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course  Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId])
}

model QuizAttempt {
  id          String   @id @default(uuid())
  studentId   String
  quizId      String
  score       Int
  passed      Boolean
  attemptedAt DateTime @default(now())

  student User @relation(fields: [studentId], references: [id], onDelete: Cascade)
  quiz    Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)
}

model Progress {
  id        String   @id @default(uuid())
  studentId String
  courseId  String
  percent   Int
  updatedAt DateTime @default(now())

  student User   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course  Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId])
}

model Plan {
  id       String @id @default(uuid())
  name     String @unique
  price    Float
  duration Int

  subscriptions Subscription[]
}

model Subscription {
  id        String   @id @default(uuid())
  studentId String
  planId    String
  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(true)

  student User @relation(fields: [studentId], references: [id], onDelete: Cascade)
  plan    Plan @relation(fields: [planId], references: [id])
}

model Certificate {
  id        String   @id @default(uuid())
  studentId String
  courseId  String
  issueDate DateTime
  fileUrl   String

  student User   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course  Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId])
}

model ForumPost {
  id        String   @id @default(uuid())
  userId    String
  courseId  String?
  title     String
  content   String
  createdAt DateTime @default(now())

  user     User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  course   Course?        @relation(fields: [courseId], references: [id], onDelete: SetNull)
  comments ForumComment[]
}

model ForumComment {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  content   String
  createdAt DateTime @default(now())

  post ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SupportTicket {
  id        String       @id @default(uuid())
  userId    String
  subject   String
  message   String
  status    TicketStatus @default(OPEN)
  createdAt DateTime     @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}
